---
layout: post
title: 学习Java9-11
published: true
---

## Java9-11新特性一览
### Java 9
* **模块化**
* Java Shell
* 新的操作系统进程的API
* G1作为默认垃圾收集器
* 加入微基准测试套件JMH
* 支持HTTP2.0和WebSocket
* 支持响应式编程(reactive program)

### Java 10
* 本地变量的类型推导
* JDK的代码库合并
* 垃圾收集接口
* 并行化的G1全垃圾收集器(full GC)
* 应用级别的类数据共享
* Thread-local handshakes(一种可以不通过safepoint就实现单个线程的停止的新机制)
* 移除javah工具
* 支持更多的Unicode语言标记扩展
* 支持非DRAM内存设备
* 加入实验性的基于Java的JIT(just-in-time)编译器
* 加入一些默认的根证书

### Java 11
* 动态的class文件常量
* Epsilon,一个新的低开销的垃圾收集器
* 移除Java EE和CORBRA模块
* 可以在lambda的参数中使用`var`语法

## JDK内部改进
9-11也进行了很多JDK内部的改进,这些修改主要是对JVM内部实现的一些修改和优化,其实和一般的开发人员关系不大.它们都有对应的JEP(JDK Enhancement Proposal),下面是其中一些比较重要的JEP:

### Improved contended locking
Java对多个线程共享的数据的管理做的不错,它为每个对象和类分配一个monitor,这些monitor的锁在任何时候只会被一个线程控制.从本质上说,这些锁就是给予了线程这些对象的monitor.如果有其他线程在等待这个锁的队列中,那么就叫竞争锁.
这个JEP的目的是为了提高JVM管理竞争锁的整体性能,它的提升主要体现在下面三个操作:
* Faster monitor enter
* Faster monitor exit
* Faster notifications

### Segmented code cache
分段的代码缓存.这个改进使得JVM有更快的更高效的运行时.它的核心是把代码缓存分成三块,每一块存储特定类型的编译好的代码,
<div align="center"><img width="660" height="520" src="https://zjjfly.github.io/images/20190529/j911-1.JPG"/></div>
代码缓存区是一个固定大小的区域.默认情况下,其中有3MB是固定存放non-methed代码的,剩余的部分平均分配给profiled和non-profiled代码.用户可以通过JVM参数手动调节.
> -xx:NonMethodCodeHeapSize
> -xx:ProfiledCodeHeapSize
> -xx:NonProfiledCodeHeapSize

### Smart Java compilation
`sjavac`,一个更智能的`javac`,支持增量编译,加快了编译速度,但目前还没有替代`javac`.

### Resolve Lint and Doclint Warnings
之前的JDK编译的时候会由`javac`发出很多lint(字节码和源码检查)和doclint(javadoc检查)告警,这个提案就是为了处理这些告警,至少是核心库的告警.

### Tiered attribution for Javac
`javac`会在编译的时候进行类型推断,之前使用的是一种推断归因工具,这种工具的类型推断结果虽然准确但性能不高,现在使用一种新的叫做分层归因工具替代它,目的还是为了加快编译速度.

### Annotations pipeline 2.0
在Java8中,引入了三个特性：
* lambda表达式
* 重复注解
* 类型注解
  
这三个特性影响了Java注解,但`javac`没有对原有的对注解的处理做修改,而是加入了一些硬编码对这些新的注解进行处理,但这种方式效率不高而且维护麻烦,所以这个改进是为了去掉这些硬编码,重构了处理注解的代码.

### New version-string scheme
新的版本命名格式,原来是使用`8u211`这样的格式,现在使用的是形如`12.0.1`的格式.

### Generating runtime compiler tests automatically
Java支持很多平台,所以要在所有平台上测试运行时编译器(JIT)是一件非常麻烦的事情,现在引入了一个新的工具用于自动生成目标平台的JIT的测试代码.

### Testing class-file attributes generated by javac
之前的JDK中没有方法可以测试`javac`生成的类文件的属性是否正确,现在加入了这方面的工具.

### Storing interned strings in class-data sharing archives
共享类数据(class-data sharing)是Java5的时候引入的新特性.在JVM安装过程中,安装进程会加载一系列核心JVM类(比如 rt.jar)到一个共享的内存映射区域.CDS减少了加载这些类需要的时间,提高了JVM启动的速度,允许这些类被不同的JVM实例共享,同时也减少了内存消耗.但在9之前的实现还是不够高效,并且只支持Boot ClassLoader加载的类,9和11分别对这两个问题进行了处理.

### Compact strings
紧凑字符串.之前的字符串的底层使用的是`char[]`存储.一个char要占16bits,但实际开发过程占,使用最多的是`Latin-1`字符,它们只需占用8bits或者说1byte.现在内部使用`byte[]`来存储,节约了内存空间.

### Merging selected Xerces 2.11.0 updates into JAXP
把Xerces2.11.0(一个Java的XML处理库)的部分更新合入JAXP(Java的处理XML的API).

### Unicode 8.0.0
支持Unicode8.0.0标准

### Reserved stack areas for critical sections
为关键代码区域加上保留的线程栈空间,以此来减少发生`StackOverflowError`,的可能性.如果当前执行的方法的栈空间不够了,但这个方法有注解`jdk.internal.vm.annotation.ReservedStackAccess`,那么就会分配一段临时的栈空间让方法继续执行.当然,如果需要的额外空间很大,最终还是会抛出`StackOverflowError`.

### Additional tests for humongous objects in G1

## 重要特性详解
从上面的一览可以看出,9-11的新特性还是很多的,其中有一些和我们关系不是很大,所以不再详述.下面是我个人认为比较重要的特性的详细解读.
